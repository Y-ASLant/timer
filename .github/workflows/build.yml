name: Build

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

env:
  CARGO_TERM_COLOR: always

jobs:
  build:
    if: >
      contains(github.event.head_commit.message, 'build:') ||
      github.event_name == 'pull_request'
    strategy:
      fail-fast: false
      matrix:
        platform:
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            name: Windows x64
          - os: ubuntu-22.04
            target: x86_64-unknown-linux-gnu
            name: Linux x64
          - os: ubuntu-20.04
            target: x86_64-unknown-linux-gnu
            name: Linux x64 (webkit2gtk-4.0)
            webkit_version: "4.0"

    runs-on: ${{ matrix.platform.os }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.platform.target }}

      - name: Install Linux dependencies (webkit2gtk-4.1)
        if: matrix.platform.os == 'ubuntu-22.04'
        run: |
          sudo apt-get update
          sudo apt-get install -y libwebkit2gtk-4.1-dev \
            build-essential \
            curl \
            wget \
            file \
            libssl-dev \
            libayatana-appindicator3-dev \
            librsvg2-dev \
            imagemagick

      - name: Install Linux dependencies (webkit2gtk-4.0)
        if: matrix.platform.os == 'ubuntu-20.04'
        run: |
          sudo apt-get update
          sudo apt-get install -y libwebkit2gtk-4.0-dev \
            build-essential \
            curl \
            wget \
            file \
            libssl-dev \
            libayatana-appindicator3-dev \
            librsvg2-dev \
            imagemagick

      - name: Generate PNG icons from ICO (Linux)
        if: startsWith(matrix.platform.os, 'ubuntu')
        run: |
          convert icons/icon.ico[0] -resize 32x32 -define png:color-type=6 icons/32x32.png
          convert icons/icon.ico[0] -resize 128x128 -define png:color-type=6 icons/128x128.png
          convert icons/icon.ico[0] -resize 256x256 -define png:color-type=6 icons/128x128@2x.png

      - name: Rust cache
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: './src-tauri -> target'

      - name: Install Tauri CLI
        run: cargo install tauri-cli --version "^2.0.0" --locked

      - name: Build Tauri app (webkit2gtk-4.1)
        if: matrix.platform.webkit_version != '4.0'
        working-directory: ./src-tauri
        run: cargo tauri build --verbose
        env:
          GITHUB_API_TOKEN: ${{ secrets.API_TOKEN }}

      - name: Build Tauri app (webkit2gtk-4.0)
        if: matrix.platform.webkit_version == '4.0'
        working-directory: ./src-tauri
        run: cargo tauri build --verbose --features webkit2gtk-4-0
        env:
          GITHUB_API_TOKEN: ${{ secrets.API_TOKEN }}

      - name: Compress binaries (Linux)
        if: startsWith(matrix.platform.os, 'ubuntu')
        run: |
          # 使用UPX进一步压缩二进制文件
          sudo apt-get install -y upx
          find src-tauri/target/release -name "countdown-timer" -type f -exec upx --best --lzma {} \; || true

      - name: Upload artifacts (Windows)
        if: matrix.platform.os == 'windows-latest'
        uses: actions/upload-artifact@v4
        with:
          name: timer-${{ matrix.platform.name }}
          path: |
            src-tauri/target/release/bundle/msi/*.msi
            src-tauri/target/release/bundle/nsis/*.exe
          if-no-files-found: warn

      - name: Upload artifacts (Linux)
        if: startsWith(matrix.platform.os, 'ubuntu')
        uses: actions/upload-artifact@v4
        with:
          name: timer-${{ matrix.platform.name }}
          path: |
            src-tauri/target/release/bundle/deb/*.deb
            src-tauri/target/release/bundle/rpm/*.rpm
          if-no-files-found: warn
